var app = angular.module('tupper', ['ui.router']);

app.config([
	'$stateProvider',
	'$urlRouterProvider',
	function($stateProvider, $urlRouterProvider) {

	  $stateProvider
	    .state('display', {
	      url: '/display',
	      templateUrl: '/display.html',
	      controller: 'DisplayCtrl'
	    })
	    .state('generate', {
			  url: '/generate',
			  templateUrl: '/generate.html',
			  controller: 'GenerateCtrl'
			});

	  $urlRouterProvider.otherwise('display');
	}
]);

app.factory('utils', [function() {
	var utils = {
		
		max: bigInt("4858487703217654168507377107565676789145697178497253677539145555247620343537955749299116772611982962556356527603203744742682135448820545638134012705381689785851604674225344958377377969928942335793703373498110479735981161931616997837568312568489938311294622859986621379234205529965392091893253288500432782862263410646820171439206408889517627953930924005233285455643232746873900205120036557171717499335122490912065694632935352302178602108137941774883061885522205403967593003199773578952627785152838963495027790689532144351329310799436758088941551"),

		samples: [
			"960939379918958884971672962127852754715004339660129306651505519271702802395266424689642842174350718121267153782770623355993237280874144307891325963941337723487857735749823926629715517173716995165232890538221612403238855866184013235585136048828693337902491454229288667081096184496091705183454067827731551705405381627380967602565625016981482083418783163849115590225610003652351370343874461848378737238198224849863465033159410054974700593138339226497249461751545728366702369745461014655997933798537483143786841806593422227898388722980000748404719",
			"91511821132700346498010439346242040650054426742115542921153750571706453650565455934327759508756624668120419316566253161544192516758002047766742615851293837290490793958723720416523543161745225402749611958843457108268939601144901930723486954841410581483991024015166990067840058166439724613212715181082766332636981871502750717506842087834199465552115331231266056229674510912387313366944402870026735817650696872012393086993",
			"76088918902477584733751875591156400060512494569681968380307937960377579186371296309302266922009220473811366133034463478400376645578084075047640548756285094705568519936035133126077469526859758809927008375682158361872550778693425604076162567972883927163030092812060686382464453989688983312253146354377046500703183155757554027081360878527331968141947880457764630368650260525496385092700001458149662857634113564729230440954082366936011346877349093528141558812407903096837364023077912576228720657"
		],
		
		generateBitmap: function(strValue) {
			var k = bigInt(strValue);
			var k2str = this.padWithZeroes(k.divide(17).toString(2), 1802);
			var bitmap = [];
			for (var i=0; i<17; i++) {
				bitmap.push([]);
			}
			for (var i=0; i<k2str.length; i++) {
				var b = parseInt(k2str[i]);
				var row = 16 - (i%17);
				bitmap[row].push(b);
			}
			return bitmap;
		},

		padWithZeroes: function(number, length) {
	    var my_string = '' + number;
	    while (my_string.length < length) {
        my_string = '0' + my_string;
	    }
	    return my_string;
		},

		calculateCellSize: function() {
			var graphWidth = angular.element(document.getElementById('graph'))[0].clientWidth;
			return graphWidth/106;
		}

	};
	return utils;
}]);

app.controller('DisplayCtrl', [
	'$scope',
	'utils',
	function($scope, utils) {
		$scope.cellSize = utils.calculateCellSize();
		angular.element(document.getElementById('nav-display'))[0].className = "active";
		angular.element(document.getElementById('nav-generate'))[0].className = "";
		
		$scope.default = function() {
			$scope.kRange = -1;
			$scope.k = utils.samples[0];
			$scope.display();
		}
		$scope.display = function() {
			$scope.bitmap = utils.generateBitmap($scope.k);
		}
   	$scope.$watch('kRange', function() {
     	if ($scope.kRange >= 0) {
     		$scope.k = utils.max.multiply($scope.kRange).divmod(100).quotient;
     		$scope.display();	
     	}
   	});
   	
   	$scope.default();
	}
]);

app.controller('GenerateCtrl', [
	'$scope',
	'utils',
	function($scope, utils) {
		angular.element(document.getElementById('nav-display'))[0].className = "";
		angular.element(document.getElementById('nav-generate'))[0].className = "active";	
	}
]);